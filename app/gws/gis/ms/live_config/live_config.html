<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Mapserver Live Config</title>
    <style>
        body {
            background-color: #151618;
            padding: 0;
            margin: 0;
            font-family: "JetBrains Mono NL", monospace;
            font-size: 13px;
        }

        * {
            box-sizing: border-box;
        }

        .main {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 520px;
            height: 100%;
            padding: 10px 20px 10px 10px;
            position: relative;
        }

        .sidebar textarea {
            width: 100%;
            height: 90%;
            margin: 0;
            padding: 10px;
            border: 1px solid #ccc;
            color: #00D000;
            background-color: transparent;
            resize: none;
        }

        .map {
            flex: 1;
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAAAAACMxyj6AAAAKklEQVQI12MMZmBgYPggwMDAwMDEgADEsFk+MDAwMDB8YGBgYGARIN8cAGjQBF3P+RUfAAAAAElFTkSuQmCC);
            background-color: #4b4d4f;
            padding: 20px;
        }

        .map img {
            border: 1px solid #ccc;
        }

        .toolbar {
            display: flex;
            align-items: center;
        }

        .toolbar button {
            margin: 10px 10px 0 0;
            padding: 10px;
        }

        #wait {
            flex: 1;
            text-align: right;
            font-weight: bold;
            color: white;
        }

        #resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            bottom: 0;
            cursor: ew-resize;
            background-color: rgb(97, 29, 206);
        }
    </style>

    <script>
        let $ = s => document.querySelector(s);

        async function renderMap() {
            let textarea = $(".sidebar textarea");
            let image = $(".map img");
            let content = textarea.value;

            $("#wait").innerText = 'Rendering...';

            let response = await fetch('/ms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/octet-stream'
                },
                body: content
            });

            let blob = await response.blob();
            image.src = URL.createObjectURL(blob);

            $("#wait").innerText = '';
        }

        function formatTextArea() {
            let textarea = $(".sidebar textarea");
            let f = format(textarea.value);
            textarea.value = f;
        }

        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function format(mapText) {
            let stack = [];
            let out = [];

            for (let line of mapText.trim().split('\n')) {
                out.push(formatLine(line, stack));
            }
            return out.join('\n') + '\n';
        }

        function formatLine(line, stack) {
            let s = line.trim();

            if (s.match(/^END\b/i)) {
                let kw = stack.pop() || '';
                return ' '.repeat(2 * stack.length) + 'END #' + kw;
            }

            if (s.match(/^[A-Za-z]+$/)) {
                stack.push(s.toUpperCase());
                return ' '.repeat(2 * (stack.length - 1)) + s.toUpperCase();
            }

            if (!s) {
                return '';
            }

            let m = s.match(/^([A-Za-z]+)(\s|=)(.*)$/);
            if (m) {
                return ' '.repeat(2 * stack.length) + m[1].toUpperCase() + m[2] + m[3].trim();
            }

            return ' '.repeat(2 * stack.length) + s;
        }

        let DEFAULT_MAP = `{DEFAULT_MAP}`;

        function initEvents() {
            $("#btnFormat").addEventListener("click", formatTextArea);
            $("#btnRender").addEventListener("click", renderMap);

            document.addEventListener("keydown", (e) => {
                if (e.key === "F2") {
                    formatTextArea();
                } else if (e.key === "F3") {
                    renderMap();
                }
            });

            $(".sidebar textarea").addEventListener('input', (e) => {
                localStorage.setItem('mapseContent', $(".sidebar textarea").value);
            });

            let resizer = $("#resizer");
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                document.addEventListener('mousemove', resizeSidebar);
                document.addEventListener('mouseup', stopResize);
            });

            const minWidth = 200;

            function resizeSidebar(e) {
                let sidebar = $(".sidebar");

                let w = e.clientX - sidebar.getBoundingClientRect().left;
                if (minWidth < w && w < window.innerWidth - minWidth) {
                    sidebar.style.width = w + 'px';
                }
            }

            function stopResize() {
                document.removeEventListener('mousemove', resizeSidebar);
                document.removeEventListener('mouseup', stopResize);
            }
        }


        document.addEventListener("DOMContentLoaded", () => {
            let savedContent = localStorage.getItem('mapseContent');
            console.log("Saved content:", typeof(savedContent), savedContent);
            $(".sidebar textarea").value = savedContent || format(DEFAULT_MAP);

            initEvents();
            renderMap();
        });

    </script>
</head>

<body>
    <div class="main">
        <div class="sidebar">
            <textarea wrap="off"></textarea>
            <div class="toolbar">
                <button id="btnFormat">F2 - format</button>
                <button id="btnRender">F3 - render</button>
                <div id="wait"></div>
            </div>
            <div id="resizer"></div>
        </div>
        <div class="map">
            <img>
        </div>
    </div>
</body>

</html>
@let WITH_DEBUG = 1

@let HEADERS = {

    'flurstueck': 'Flurstück',
    'flurstueck.flurnummer': 'Flurnummer',
    'flurstueck.zaehler': 'Zähler',
    'flurstueck.nenner': 'Nenner',
    'flurstueck.gemeinde': 'Gemeinde',
    'flurstueck.gemarkung': 'Gemarkung',
    'flurstueck.amtlicheFlaeche': 'Fläche (amtlich)',
    'flurstueck.area': 'Fläche (geometrisch)',
    'flurstueck.gebaeudeGrundflaeche': 'Gesamtfläche (amtlich)',
    'flurstueck.gebaeudeArea': 'Gesamtfläche (geometrisch)',
    'flurstueck.nachfolgerFlurstueckskennzeichen': 'Nachfolger-Flurstückskennzeichen',

    'lage.title': 'Angaben zur Lage',
    'lage.adresse': 'Adresse',

    'gebaeude.title': 'Gebäudenachweis',
    'gebaeude': 'Gebäude',
    'gebaeude.grundflaeche': 'Fläche (amtlich)',
    'gebaeude.area': 'Fläche (geometrisch)',

    'buchung.title': 'Personen und Bestandsdaten',
    'buchung.buchungsstelle': 'Buchungsstelle',

    'buchungsblatt.title': 'Buchungsblatt',
    'buchungsblatt.blattart': 'Blattart',
    'buchungsblatt.buchungsblattbezirk': 'Bezirk',

    'buchungsstelle.title': 'Buchungsstelle',
    'buchungsstelle.buchungsart': 'Buchungsart',
    'buchungsstelle.laufendeNummer': 'Nr',
    'buchungsstelle.zu': 'zu',
    'buchungsstelle.flurstueck': 'Flurstück',
    'buchungsstelle.buchungstext': 'Buchungstext',
    'buchungsstelle.beschreibungDesSondereigentums': 'Beschreibung des Sondereigentums',
    'buchungsstelle.beschreibungDesUmfangsDerBuchung': 'Beschreibung des Umfangs der Buchung',

    'namensnummer.title': 'Eigentümer',
    'namensnummer.anteil': 'Anteil',
    'namensnummer.laufendeNummer': 'Nr.',
    'namensnummer.rechtsgemeinschaft': 'Rechtsgemeinschaft',
    'namensnummer.eigentuemerart': 'Eigentümerart',

    'person.title': 'Angaben zur Person',
    'person.name': 'Name',
    'person.anschrift': 'Anschrift',
    'person.adresse': 'Adresse',
    'person.geburtsdatum': 'Geburtsdatum',

    'nutzung.title': 'Tatsächliche Nutzung',
    'nutzung.name': 'Art',
    'nutzung.area': 'Fläche',

    'zeitraum': 'Zeitraum',
    'anlass': 'Anlass',
}


@def h arg
    @return HEADERS.get(arg, arg)
@end

@def text arg, default=None
    @without arg
        @return default
    @end
    @with arg.text
        @return arg.text + ' (' + arg.code + ')'
    @end
    @return str(arg)
@end

@def area arg
    @if arg
        @return '{:.1f}&nbsp;m²'.format(arg)
    @end
@end

@def join(a, delim)
    @let vs = []
    @for arg in a
        @let v = text(arg)
        @if v != None
            @do vs.append(v)
        @end
    @end
    @if not vs
        @return None
    @end
    @return delim.join(vs)
@end

@def nl(*a)    = join(a, '<br>')
@def space(*a) = join(a, ' ')
@def dot(*a)   = join(a, '.')

@box section content, title=None
    <div class="alkisFsSection1">
        @if title
            <p class="alkisFsTitle">{title}</p>
        @end
        {content}
    </div>
@end

@box subsection content, title=None
    <div class="alkisFsSection2">
        @if title
            <p class="alkisFsTitle">{title}</p>
        @end
        {content}
    </div>
@end

@box table content
    <table>
    {content}
    </table>
@end

@box tbody content, obj
    <tbody {'class="alkisFsHistory"' if obj.endet else ''}>
    {content}
    </tbody>
@end


@def row_title s
    @if s != None
        <tr><td colspan="2" class="alkisFsSubhead1">{s}</td></tr>
    @end
@end

@def row_subtl s
    @if s != None
        <tr><td colspan="2" class="alkisFsSubhead2">{s}</td></tr>
    @end
@end

@def row_value key, val
    @if key != None and val != None
        <tr><th>{key}</th><td>{val}</th></tr>
    @end
@end

@def row_times obj
    @if withHistory
        <tr>
            <th>{h('zeitraum')}</th>
            <td>
                @if obj.endet == obj.beginnt
                    ...&nbsp;&mdash;&nbsp;{obj.endet}
                @elif obj.endet
                    {obj.beginnt}&nbsp;&mdash;&nbsp;{obj.endet}
                @else
                    {obj.beginnt}&nbsp;&mdash;&nbsp;...
                @end
            </td>
        </tr>
        @with obj.anlass
            <tr>
                <th>{h('anlass')}</th>
                <td>{text(obj.anlass)}</td>
            </tr>
        @end
    @end
@end

@def row_debug key, val
    @if withDebug
        <tr>
            <th><span class="alkisFsDebug">{key}</span></th>
            <td><span class="alkisFsDebug">{val}</span></td>
        </tr>
    @end
@end

@def debug val
    @if withDebug
        @return '<span class="alkisFsDebug">' + str(val) + '</span>'
    @end
@end

@def fs_kennzeichen(k)
    @return k.replace('_', '')
@end

@def records(obj)
    @return obj.recs or []
@end

@def records_from(obj_list)
    @let ls = []
    @for o in obj_list
        @for r in o.recs
            @do ls.append(r)
        @end
    @end
    @return ls
@end

@######

@def anschrift an
    @for r in records(an)
        @tbody r
            @row_value h('person.adresse'), nl(space(r.strasse, r.hausnummer), space(r.plz, r.ort))
            @row_times r
        @end
    @end
@end

@def person pe
    @for r in records(pe)
        @tbody r
            @row_debug 'person.uid', r.uid
            @row_value h('person.name'), space(r.anrede, r.akademischerGrad, r.vorname, r.nachnameOderFirma)
            @row_value h('person.geburtsdatum'), r.geburtsdatum
            @row_times r
        @end
    @end
    @with pe.anschriftList
        @row_subtl h('person.anschrift')
        @for an in pe.anschriftList
            @anschrift an
        @end
    @end
@end

@def namensnummer nn
    @table
        @row_title space(h('namensnummer.title'), text(nn.laufendeNummer))

        @for r in records(nn)
            @tbody r
                @row_debug 'namensnummer.uid', r.uid
                @row_value h('namensnummer.anteil'), text(r.anteil)
                @row_value h('namensnummer.rechtsgemeinschaft'), nl(r.artDerRechtsgemeinschaft, r.beschriebDerRechtsgemeinschaft)
                @row_value h('namensnummer.eigentuemerart'), text(r.eigentuemerart)
                @row_times r
            @end
        @end

        @with nn.personList
            @row_subtl h('person.title')
            @for pe in nn.personList
                @person pe
            @end
        @end
    @end
@end


@def buchungsstelle bs
    @table
        @row_title space(h('buchungsstelle.title'), text(bs.laufendeNummer))

        @for r in records(bs)
            @tbody r
                @row_debug 'buchungsstelle.uid', r.uid
                @row_value h('buchungsstelle.buchungsart'), text(r.buchungsart)
                @row_value h('buchungsstelle.buchungstext'), text(r.buchungstext)
                @row_value h('buchungsstelle.beschreibungDesSondereigentums'), text(r.beschreibungDesSondereigentums)
                @row_value h('buchungsstelle.beschreibungDesUmfangsDerBuchung'), text(r.beschreibungDesUmfangsDerBuchung)
                @row_times r
            @end
        @end

        @with bs.parentRefs
            <tr>
                <th>{h('buchungsstelle.zu')}</th>
                <td>
                    @for ref in bs.parentRefs
                        <p>{dot(ref.bbKennzeichen, ref.bsLaufendeNummer)} {debug(ref.bsUid)}</p>
                    @end
                </td>
            </tr>
        @end

        @with bs.flurstueckskennzeichenList
            <tr>
                <th>{h('buchungsstelle.flurstueck')}</th>
                <td>
                    @for k in set(bs.flurstueckskennzeichenList)
                        <p>{fs_kennzeichen(k)}</p>
                    @end
                </td>
            </tr>
        @end
    @end
@end

@def buchungsblatt bb
    @subsection space(h('buchungsblatt.title'), bb.buchungsblattkennzeichen)
        @for r in records(bb)
            @table
                @tbody r
                    @row_debug 'buchungsblatt.uid', r.uid
                    @row_value h('buchungsblatt.blattart'), text(r.blattart)
                    @row_value h('buchungsblatt.buchungsblattbezirk'), text(r.buchungsblattbezirk)
                    @row_times r
                @end
            @end
        @end

@#        @for bs in bb.buchungsstelleList
@#            @buchungsstelle bs
@#        @end

        @for nn in bb.namensnummerList
            @namensnummer nn
        @end
    @end
@end

@def fs_buchung(fs)
    @without fs.buchungsstelleRefs
        @return
    @end

    @section h('buchung.title')
        @table
            @for ref in fs.buchungsstelleRefs
                @row_debug 'buchungsstelle.uid', ref.bsUid
                @row_value h('buchung.buchungsstelle'), dot(ref.bbKennzeichen, ref.bsLaufendeNummer)
            @end
        @end
    @end

    @for bb in fs.buchungsblattList
        @buchungsblatt bb
    @end
@end


@def fs_basis(fs)
    @for r in records(fs)
        @table
            @tbody r
                @row_debug 'flurstueck.uid', r.uid
                @row_value h('flurstueck.flurnummer'), text(r.flurnummer)
                @row_value h('flurstueck.zaehler'), text(r.zaehler)
                @row_value h('flurstueck.nenner'), text(r.nenner, '-')
                @row_value h('flurstueck.amtlicheFlaeche'), area(r.amtlicheFlaeche)
                @row_value h('flurstueck.area'), area(r.area)

                @for nf in r.nachfolgerFlurstueckskennzeichen
                    @row_value h('flurstueck.nachfolgerFlurstueckskennzeichen'), nf.replace('_', '')
                @end

                @row_times r
            @end
        @end
    @end
@end

@def fs_lage(fs)
    @section h('lage.title')
        @table
            @row_value h('flurstueck.gemeinde'),  text(fs.recs[-1].gemeinde)
            @row_value h('flurstueck.gemarkung'), text(fs.recs[-1].gemarkung)
        @end
        @for r in records_from(fs.lageList)
            @table
                @tbody r
                    @row_value h('lage.adresse'), space(r.strasse, r.hausnummer)
                    @row_times r
                @end
            @end
        @end
    @end
@end

@def fs_gebaeude(fs)
    @without fs.gebaeudeList
        @return
    @end

    @section h('gebaeude.title')
        @table
            @row_value h('flurstueck.gebaeudeGrundflaeche'), area(fs.gebaeudeGrundflaeche)
            @row_value h('flurstueck.gebaeudeArea'), area(fs.gebaeudeArea)
        @end

        @for r in records_from(fs.gebaeudeList)
            @table
                @tbody r
                    @row_debug 'gebaeude.uid', r.uid
                    @row_value h('gebaeude.gebaeudekennzeichen'), text(r.gebaeudekennzeichen)
                    @row_value h('gebaeude.grundflaeche'), area(r.grundflaeche)
                    @row_value h('gebaeude.area'), area(r.area)
                    @for k, v in r.props
                        @row_value k, text(v)
                    @end
                    @row_times r
                @end
            @end
        @end
    @end
@end


@def fs_nutzung(fs)
    @without fs.nutzungList
        @return
    @end

    @section h('nutzung.title')
        @for nu in fs.nutzungList
            @for r in records(nu)
                @table
                    @row_debug 'part.uid', nu.uid
                    @tbody r
                        @row_value h('nutzung.name'), text(nu.name)
                        @row_value h('nutzung.area'), area(r.area)
                        @for k, v in r.props
                            @row_value k, text(v)
                        @end
                        @row_times r
                    @end
                @end
            @end
        @end
    @end
@end

@def flurstueck(fs)
    @fs_basis    fs
    @fs_lage     fs
    @fs_gebaeude fs
    @fs_nutzung  fs
    @fs_buchung  fs

@end

